-- 06_create_views.sql
-- Скрипт для создания представлений (views)

BEGIN;

-- 1. Представление: Текущие остатки продуктов на складах
DROP VIEW IF EXISTS "VТекущиеОстатки" CASCADE;
CREATE VIEW "VТекущиеОстатки" AS
SELECT
    s."Название" AS "Склад",
    p."Название" AS "Продукт",
    kp."Название" AS "Категория_продукта",
    ops."Количество",
    ei."Краткое_название" AS "Ед_изм"
FROM
    "ОстатокПродуктаНаСкладе" ops
JOIN
    "Склад" s ON ops."ID_склада" = s."ID_склада"
JOIN
    "Продукт" p ON ops."ID_продукта" = p."ID_продукта"
JOIN
    "ЕдиницаИзмерения" ei ON p."ID_единицы_измерения" = ei."ID_единицы_измерения"
JOIN
    "КатегорияПродукта" kp ON p."ID_категории_продукта" = kp."ID_категории_продукта"
ORDER BY
    s."Название", p."Название";

-- 2. Представление: Список заказов с основной информацией
DROP VIEW IF EXISTS "VСписокЗаказов" CASCADE;
CREATE VIEW "VСписокЗаказов" AS
SELECT
    z."ID_заказа",
    z."Дата_создания",
    s."Фамилия" || ' ' || LEFT(s."Имя", 1) || '.' || COALESCE(LEFT(s."Отчество", 1) || '.', '') AS "Сотрудник_оформивший",
    k."Номер_кассы",
    k."Расположение" AS "Расположение_кассы",
    z."Тип_оплаты",
    z."Общая_сумма"
FROM
    "Заказ" z
JOIN
    "Сотрудник" s ON z."ID_сотрудника_оформившего" = s."ID_сотрудника"
JOIN
    "Касса" k ON z."ID_кассы" = k."ID_кассы"
ORDER BY
    z."Дата_создания" DESC;

-- 3. Представление: Детализация заказов с блюдами
DROP VIEW IF EXISTS "VДетализацияЗаказов" CASCADE;
CREATE VIEW "VДетализацияЗаказов" AS
SELECT
    z."ID_заказа",
    z."Дата_создания" AS "Дата_заказа",
    b."Название" AS "Блюдо",
    kb."Название" AS "Категория_блюда",
    pz."Количество",
    pz."Цена_на_момент_заказа" AS "Цена_за_единицу",
    (pz."Количество" * pz."Цена_на_момент_заказа") AS "Сумма_позиции"
FROM
    "ПозицияЗаказа" pz
JOIN
    "Заказ" z ON pz."ID_заказа" = z."ID_заказа"
JOIN
    "Блюдо" b ON pz."ID_блюда" = b."ID_блюда"
JOIN
    "КатегорияБлюда" kb ON b."ID_категории_блюда" = kb."ID_категории_блюда"
ORDER BY
    z."ID_заказа", b."Название";

-- 4. Представление: Детализация блюд с ингредиентами (Рецептуры) - ИСПРАВЛЕНО (версия 4, с DROP)
DROP VIEW IF EXISTS "VДетализацияБлюдСИнгредиентами" CASCADE;
CREATE VIEW "VДетализацияБлюдСИнгредиентами" AS
SELECT
    b."Название" AS "Блюдо",
    kb."Название" AS "Категория_блюда",
    b."Цена_продажи" AS "Цена_блюда", -- Новый столбец
    p."Название" AS "Ингредиент",
    kp."Название" AS "Категория_ингредиента",
    sb."Количество" AS "Количество_ингредиента",
    ei."Краткое_название" AS "Ед_изм_ингредиента"
FROM
    "СоставБлюда" sb
JOIN
    "Блюдо" b ON sb."ID_блюда" = b."ID_блюда"
JOIN
    "КатегорияБлюда" kb ON b."ID_категории_блюда" = kb."ID_категории_блюда"
JOIN
    "Продукт" p ON sb."ID_продукта" = p."ID_продукта"
JOIN
    "КатегорияПродукта" kp ON p."ID_категории_продукта" = kp."ID_категории_продукта"
JOIN
    "ЕдиницаИзмерения" ei ON p."ID_единицы_измерения" = ei."ID_единицы_измерения"
ORDER BY
    b."Название", p."Название";

-- 5. Представление: Сводка продаж по блюдам
DROP VIEW IF EXISTS "VСводкаПродажПоБлюдам" CASCADE;
CREATE VIEW "VСводкаПродажПоБлюдам" AS
SELECT
    b."Название" AS "Блюдо",
    kb."Название" AS "Категория_блюда",
    SUM(pz."Количество") AS "Продано_порций",
    SUM(pz."Количество" * pz."Цена_на_момент_заказа") AS "Общая_сумма_продаж"
FROM
    "ПозицияЗаказа" pz
JOIN
    "Блюдо" b ON pz."ID_блюда" = b."ID_блюда"
JOIN
    "КатегорияБлюда" kb ON b."ID_категории_блюда" = kb."ID_категории_блюда"
GROUP BY
    b."Название", kb."Название"
ORDER BY
    "Общая_сумма_продаж" DESC;

-- 6. Представление: Полная информация по списаниям
DROP VIEW IF EXISTS "VПолнаяИнформацияПоСписаниям" CASCADE;
CREATE VIEW "VПолнаяИнформацияПоСписаниям" AS
SELECT
    s."ID_списания",
    s."Дата_списания",
    sk."Название" AS "Склад",
    st."Фамилия" || ' ' || LEFT(st."Имя", 1) || '.' AS "Сотрудник_ответственный",
    ps."Название" AS "Причина_списания",
    'Продукт' AS "Тип_объекта",
    p."Название" AS "Наименование_объекта",
    sp."Количество",
    ei."Краткое_название" AS "Ед_изм",
    s."Комментарий"
FROM
    "СписаниеПродуктов" sp
JOIN
    "Списание" s ON sp."ID_списания" = s."ID_списания"
JOIN
    "Продукт" p ON sp."ID_продукта" = p."ID_продукта"
JOIN
    "ЕдиницаИзмерения" ei ON p."ID_единицы_измерения" = ei."ID_единицы_измерения"
JOIN
    "Склад" sk ON s."ID_склада" = sk."ID_склада"
JOIN
    "Сотрудник" st ON s."ID_сотрудника_ответственного" = st."ID_сотрудника"
JOIN
    "ПричинаСписания" ps ON s."ID_причины_списания" = ps."ID_причины_списания"
UNION ALL
SELECT
    s."ID_списания",
    s."Дата_списания",
    sk."Название" AS "Склад",
    st."Фамилия" || ' ' || LEFT(st."Имя", 1) || '.' AS "Сотрудник_ответственный",
    ps."Название" AS "Причина_списания",
    'Блюдо' AS "Тип_объекта",
    b."Название" AS "Наименование_объекта",
    sb."Количество",
    'шт.' AS "Ед_изм",
    s."Комментарий"
FROM
    "СписаниеБлюд" sb
JOIN
    "Списание" s ON sb."ID_списания" = s."ID_списания"
JOIN
    "Блюдо" b ON sb."ID_блюда" = b."ID_блюда"
JOIN
    "Склад" sk ON s."ID_склада" = sk."ID_склада"
JOIN
    "Сотрудник" st ON s."ID_сотрудника_ответственного" = st."ID_сотрудника"
JOIN
    "ПричинаСписания" ps ON s."ID_причины_списания" = ps."ID_причины_списания"
ORDER BY
    "Дата_списания" DESC, "ID_списания" DESC;

COMMIT;